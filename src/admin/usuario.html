<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios - Panel Administrador</title>
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { margin: 0; background: #FFF5E1; font-family: 'Lato', 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #5D4037; }
    .admin-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #fff8f0; border-right: 2px solid #ffe4ec; display: flex; flex-direction: column; justify-content: space-between; padding: 24px 0 16px 0; }
    .sidebar .logo { font-family: 'Pacifico', cursive; color: #8B4513; font-size: 1.5rem; text-align: center; margin-bottom: 32px; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .sidebar nav { display: flex; flex-direction: column; gap: 8px; }
    .sidebar nav a { display: flex; align-items: center; gap: 10px; padding: 10px 24px; color: #8B4513; text-decoration: none; font-weight: 600; border-radius: 8px 0 0 8px; font-size: 1rem; transition: background 0.2s, color 0.2s; }
    .sidebar nav a.active, .sidebar nav a:hover { background: #FFC0CB; color: #fff; }
    .sidebar .bottom-menu { display: flex; flex-direction: column; gap: 8px; margin-top: 24px; }
    .sidebar .profile { margin-top: 24px; text-align: center; color: #8B4513; font-size: 1rem; font-weight: 700; padding: 8px 0 0 0; border-top: 1px solid #ffe4ec; }
    .main-content { flex: 1; display: flex; flex-direction: column; background: #FFF5E1; padding: 36px 32px; }
    .admin-card { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #f3e6d8; padding: 32px 28px; margin-bottom: 24px; min-height: 180px; display: flex; flex-direction: column; align-items: flex-start; }
    .admin-card h1 { font-family: 'Pacifico', cursive; color: #8B4513; font-size: 2rem; margin: 0 0 18px 0; }
    .user-actions { display: flex; gap: 24px; margin-top: 16px; }
    .user-action-btn { background: #FFC0CB; color: #8B4513; border: none; border-radius: 10px; padding: 18px 32px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px #f3e6d8; transition: background 0.2s, color 0.2s; display: flex; align-items: center; gap: 10px; }
    .user-action-btn:hover { background: #8B4513; color: #fff; }
    @media (max-width: 700px) {
      .admin-layout { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; border-right: none; border-bottom: 2px solid #ffe4ec; }
      .sidebar nav { flex-direction: row; gap: 0; }
      .sidebar nav a { border-radius: 8px 8px 0 0; padding: 10px 12px; }
      .main-content { padding: 16px 6px; }
      .user-actions { flex-direction: column; gap: 12px; width: 100%; }
      .user-action-btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <div>
        <div class="logo">
          <img src="../assets/img/logo.png" alt="Logo" style="height: 36px; width: 36px; border-radius: 50%; box-shadow: 0 2px 8px #f3e6d8;">
          Mil Sabores
        </div>
        <nav>
          <a href="home.html"><i class="bi bi-grid-1x2"></i> Home</a>
          <a href="producto.html"><i class="bi bi-bag"></i>Productos</a>
          <a href="#" class="active"><i class="bi bi-people"></i> Usuarios</a>
        </nav>
      </div>
      <div class="profile">
        <i class="bi bi-person-circle"></i> Admin
      </div>
    </aside>
    <main class="main-content">
      <div class="admin-card">
        <h1>¿Qué desea hacer con los usuarios?</h1>
        <div class="user-actions">
          <button class="user-action-btn" id="btnAgregarUsuario"><i class="bi bi-person-plus"></i> Crear nuevo usuario</button>
          <button class="user-action-btn" id="btnEditarUsuario"><i class="bi bi-pencil-square"></i> Editar usuario</button>
          <button class="user-action-btn" id="btnMostrarUsuarios"><i class="bi bi-people"></i> Mostrar usuarios</button>
          <button class="user-action-btn" id="btnBorrarUsuario"><i class="bi bi-person-x"></i> Borrar usuario</button>
        </div>
      </div>
    </main>
  </div>
</body>
<div id="tablaUsuarios" style="margin-top:32px; display:none;"></div>
<script src="../assets/js/usuario.js"></script>
<script>
// Vinculación y lógica para listar, editar y borrar usuarios
document.addEventListener('DOMContentLoaded', function() {
  const btnMostrar = document.getElementById('btnMostrarUsuarios');
  const btnEditar = document.getElementById('btnEditarUsuario');
  const btnBorrar = document.getElementById('btnBorrarUsuario');
  const tablaDiv = document.getElementById('tablaUsuarios');

  function obtenerUsuarios() {
    let usuarios = [];
    try {
      const raw = localStorage.getItem('usuariosRegistrados');
      if (raw) {
        const HEX_RE = /^[0-9a-f]+$/i;
        function isHexLike(s) { return typeof s === 'string' && s.length % 2 === 0 && HEX_RE.test(s); }
        function hexToString(hex) { let out = ''; for (let i = 0; i < hex.length; i += 2) { out += String.fromCharCode(parseInt(hex.substr(i, 2), 16)); } return out; }
        const json = isHexLike(raw) ? hexToString(raw) : raw;
        usuarios = JSON.parse(json);
      }
    } catch {}
    return usuarios;
  }

  function renderTablaUsuarios(usuarios) {
    if (!usuarios.length) { tablaDiv.innerHTML = '<div style="color:#B71C1C;">No hay usuarios registrados.</div>'; return; }
    let html = '<table style="width:100%;border-collapse:collapse;background:#fff;"><thead><tr>';
    html += '<th>RUN</th><th>Nombre</th><th>Correo</th><th>Teléfono</th><th>Comuna</th><th>Fecha Nac.</th><th>Descuento</th><th>Torta Gratis</th></tr></thead><tbody>';
    usuarios.forEach(u => {
      html += `<tr><td>${u.run}</td><td>${u.nombre}</td><td>${u.correo}</td><td>${u.telefono}</td><td>${u.comuna}</td><td>${u.fecha}</td><td>${u.descuento||0}%</td><td>${u.tortaGratis?'Sí':'No'}</td></tr>`;
    });
    html += '</tbody></table>';
    tablaDiv.innerHTML = html;
  }

  if (btnMostrar) {
    btnMostrar.addEventListener('click', function() {
      const usuarios = obtenerUsuarios();
      renderTablaUsuarios(usuarios);
      tablaDiv.style.display = 'block';
    });
  }

  if (btnEditar) {
    btnEditar.addEventListener('click', function() {
      let rut = prompt('Ingrese el RUN del usuario a editar:');
      if (!rut) return;
      let usuarios = obtenerUsuarios();
      let usuario = usuarios.find(u => u.run === rut);
      if (!usuario) { alert('Usuario no encontrado.'); return; }
      // Rellenar el modal de agregar con los datos del usuario
      document.getElementById('btnAgregarUsuario').click();
      setTimeout(() => {
        const form = document.getElementById('formAgregarUsuario');
        if (!form) return;
        form.elements['run'].value = usuario.run;
        form.elements['nombre'].value = usuario.nombre;
        form.elements['correo'].value = usuario.correo;
        form.elements['password'].value = usuario.password;
        form.elements['fecha'].value = usuario.fecha;
        form.elements['telefono'].value = usuario.telefono;
        form.elements['comuna'].value = usuario.comuna;
        form.elements['codigo'].value = usuario.codigoUsado || '';
        // Al guardar, sobreescribir el usuario existente
        form.onsubmit = function(e) {
          e.preventDefault();
          let datos = Object.fromEntries(new FormData(form));
          let usuarios = obtenerUsuarios();
          let idx = usuarios.findIndex(u => u.run === rut);
          if (idx === -1) { alert('Usuario no encontrado.'); return; }
          usuarios[idx] = { ...usuarios[idx], ...datos, codigoUsado: datos.codigo };
          try {
            const json = JSON.stringify(usuarios);
            function stringToHex(str) { return Array.from(str).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(''); }
            localStorage.setItem('usuariosRegistrados', stringToHex(json));
            alert('Usuario editado exitosamente.');
            document.getElementById('modalAgregarUsuario').style.display = 'none';
          } catch (e) { alert('No se pudo editar el usuario.'); }
        };
      }, 300);
    });
  }

  if (btnBorrar) {
    btnBorrar.addEventListener('click', function() {
      let rut = prompt('Ingrese el RUN del usuario a borrar:');
      if (!rut) return;
      let usuarios = obtenerUsuarios();
      let idx = usuarios.findIndex(u => u.run === rut);
      if (idx === -1) { alert('Usuario no encontrado.'); return; }
      if (!confirm('¿Está seguro de borrar este usuario?')) return;
      usuarios.splice(idx, 1);
      try {
        const json = JSON.stringify(usuarios);
        function stringToHex(str) { return Array.from(str).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(''); }
        localStorage.setItem('usuariosRegistrados', stringToHex(json));
        alert('Usuario borrado exitosamente.');
        tablaDiv.style.display = 'none';
      } catch (e) { alert('No se pudo borrar el usuario.'); }
    });
  }
});
</script>
</html>
