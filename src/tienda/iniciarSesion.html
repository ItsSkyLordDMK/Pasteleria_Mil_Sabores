<!DOCTYPE html>
<html lang="es">
<head>
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar Sesión - Mil Sabores</title>
  <link rel="stylesheet" href="../assets/css/styles.css" />
  <style>
    body {
      background: #FFF5E1;
      color: #5D4037;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #FFC0CB;
      box-shadow: 0 2px 8px #f3e6d8;
      transition: all 0.3s cubic-bezier(.4,0,.2,1);
      padding: 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    .sticky-header.shrink {
      padding: 6px 0;
      box-shadow: 0 1px 4px #f3e6d8;
    }
    .sticky-header .logo img {
      height: 32px;
      width: 32px;
      border-radius: 50%;
      box-shadow: 0 2px 8px #f3e6d8;
      transition: height 0.3s, width 0.3s;
    }
    .text-principal { color: #5D4037 !important; }
    .text-secundario { color: #B0BEC5 !important; }
  </style>
</head>
<body style="background: linear-gradient(135deg, #FFF5E1 0%, #FFE4EC 100%); font-family: 'Lato', 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
  <!--======================= HEADER =======================-->
  <header class="topbar sticky-header" id="mainHeader" style="padding: 8px 0;">
    <div class="logo" style="display: flex; align-items: center; gap: 8px;">
      <img src="../assets/img/logo.png" alt="Logo Mil Sabores" style="height: 32px; width: 32px; border-radius: 50%; box-shadow: 0 2px 8px #f3e6d8;">
      <strong style="font-family: 'Pacifico', cursive; font-size: 1.3rem; color: #8B4513; letter-spacing: 1px;">Mil Sabores</strong>
    </div>
    <div>
      <strong style="font-family: 'Lato', sans-serif; color: #8B4513; font-size: 1rem;">Tienda online - Mil Sabores</strong>
    </div>
    <nav class="navegacion" aria-label="Navegación principal">
      <a href="/index.html" class="text-principal" style="font-weight: 600;">Página principal</a>
    </nav>
    <div class="usuario">
      <span class="separar text-secundario">|</span>
      <a href="registro.html" class="text-principal" style="font-weight: 600;">¿No tienes cuenta? Registrate Aquí</a>
      <span class="separar text-secundario">|</span>
    </div>
    <!-- Aquí aparecerá el usuario -->
    <div id="usuario-info" style="margin-left:auto; font-weight:600; color:#8B4513;"></div>
  </header>

  <!-- ======================= MAIN ======================= -->
  <main class="main">
    <div class="form-container" style="background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #f3e6d8; max-width: 400px; margin: 40px auto; padding: 36px 32px 28px 32px;">
      <h1 style="font-family: 'Pacifico', cursive; font-size: 2.1rem; text-align: center; margin-bottom: 10px;" class="text-principal">Iniciar Sesión</h1>
      <p class="text-secundario" style="text-align: center; margin-bottom: 30px; font-size: 1.05rem;">
        Accede a tu cuenta para disfrutar de nuestros deliciosos postres
      </p>
      <form id="form-login" method="post" novalidate>
        <!-- Correo Electrónico -->
        <div class="form-group" style="margin-bottom: 18px;">
          <label for="correo" style="font-weight: 600; color: #8B4513;">Correo Electrónico:</label>
          <input type="email" id="correo" name="correo" required style="border-radius: 10px; border: 1.5px solid #ffe4ec; padding: 10px; background: #fff8f0; font-size: 1rem;" />
          <div class="error-message" id="error-correo" style="color: #EF4444; font-size: 0.92rem; margin-top: 4px;"></div>
        </div>
        <!-- Contraseña -->
        <div class="form-group" style="margin-bottom: 18px;">
          <label for="password" style="font-weight: 600; color: #8B4513;">Contraseña:</label>
          <input type="password" id="password" name="password" required style="border-radius: 10px; border: 1.5px solid #ffe4ec; padding: 10px; background: #fff8f0; font-size: 1rem;" />
          <div class="error-message" id="error-password" style="color: #EF4444; font-size: 0.92rem; margin-top: 4px;"></div>
        </div>
        <!-- Recordar sesión -->
        <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
          <input type="checkbox" id="recordar" name="recordar" style="accent-color: #FFC0CB; width: 18px; height: 18px;" />
          <label for="recordar" style="margin-bottom: 0; font-weight: 500; color: #8B4513;">Recordar mi sesión</label>
        </div>
        <!-- Botones -->
        <button type="submit" class="btn-primaria" style="width: 100%; background: #8B4513; color: #fff; font-weight: 700; border-radius: 10px; border: none; padding: 12px 0; font-size: 1.08rem; margin-bottom: 10px; font-family: 'Lato', sans-serif;">Iniciar Sesión</button>
        <button type="button" class="btn-secundaria" onclick="window.location.href='registro.html'" style="width: 100%; background: #fff8f0; color: #8B4513; font-weight: 600; border-radius: 10px; border: 1.5px solid #FFC0CB; padding: 10px 0; font-size: 1rem;">¿No tienes cuenta? Regístrate aquí</button>
      </form>
      <div style="text-align: center; margin-top: 20px;">
        <a href="#" style="color: #8B4513; text-decoration: underline; font-size: 0.95rem;">¿Olvidaste tu contraseña?</a>
      </div>
      <div class="success-message" id="success-message" style="display: none; text-align: center; color: #10B981; font-weight: 700; margin-top: 18px; font-size: 1.05rem;">¡Inicio de sesión exitoso! Redirigiendo...</div>
      <div class="error-message" id="login-error" style="display: none; text-align: center; margin-top: 20px; color: #EF4444; font-weight: 600; font-size: 1.05rem;">Credenciales incorrectas. Verifica tu correo y contraseña.</div>
    </div>
  </main>

  <!-- ======================= FOOTER ======================= -->
  <footer class="footer" id="contacto" style="background: #fff8f0; border-top: 2px solid #ffe4ec; margin-top: 40px;">
    <nav aria-label="Redes" style="text-align: center; margin-bottom: 10px;">
      <a href="#" style="color: #8B4513; font-weight: 600;">X</a> ·
      <a href="#" id="blog" style="color: #8B4513; font-weight: 600;">Instagram</a> ·
      <a href="#" style="color: #8B4513; font-weight: 600;">WhatsApp</a>
    </nav>
  </footer>

  <!-- JavaScript -->
  <script defer src="../assets/js/iniciarSesion.js"></script>
  <script defer src="../assets/js/cerrarSesion.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('form-login');
      const correoInput = document.getElementById('correo');
      const passwordInput = document.getElementById('password');

      // ✅ Mostrar nombre en el header si hay sesión activa
      (function pintarUsuarioHeader(){
        const userDiv = document.getElementById('usuario-info');
        if (!userDiv) return;

        let sesion = null;
        const rawLocal = localStorage.getItem('sesionActiva');
        const rawSession = sessionStorage.getItem('sesionActiva');
        if (rawLocal) sesion = JSON.parse(rawLocal);
        else if (rawSession) sesion = JSON.parse(rawSession);

        if (sesion && sesion.nombre) {
          userDiv.innerHTML = `
            <span>Hola, ${sesion.nombre}</span>
            <button onclick="cerrarSesion()" style="margin-left:8px; background:#8B4513; color:#fff; border:none; border-radius:6px; padding:4px 10px; cursor:pointer;">
              Cerrar sesión
            </button>
          `;
        } else {
          userDiv.innerHTML = `<a href="iniciarSesion.html" style="color:#8B4513; font-weight:600;">Iniciar sesión</a>`;
        }
      })();

      // ✅ ahora usamos siempre la función que decodifica HEX
      const usuariosRegistrados = obtenerUsuarios();

      function validarEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
      function mostrarError(id, msg){ const c=document.getElementById(id),e=document.getElementById('error-'+id); c.classList.remove('valid'); c.classList.add('invalid'); e.textContent=msg; e.classList.add('show'); }
      function mostrarExito(id){ const c=document.getElementById(id),e=document.getElementById('error-'+id); c.classList.remove('invalid'); c.classList.add('valid'); e.classList.remove('show'); }
      function limpiarError(id){ const c=document.getElementById(id),e=document.getElementById('error-'+id); c.classList.remove('invalid','valid'); e.classList.remove('show'); }
      function mostrarErrorLogin(msg){ const e=document.getElementById('login-error'); e.textContent=msg; e.classList.add('show'); e.style.display='block'; document.getElementById('success-message').style.display='none'; }
      function mostrarExitoLogin(){ const s=document.getElementById('success-message'); s.style.display='block'; document.getElementById('login-error').style.display='none'; }

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const correo = correoInput.value.trim();
        const password = passwordInput.value;
        const recordar = document.getElementById('recordar').checked;
        let esValido = true;
        // Validación correo
        if (!correo) {
          mostrarError('correo', 'El correo electrónico es requerido');
          esValido = false;
        } else if (correo.length > 100) {
          mostrarError('correo', 'El correo no puede superar los 100 caracteres');
          esValido = false;
        } else if (!/^[^\s@]+@(duoc\.cl|profesor\.duoc\.cl|gmail\.com)$/i.test(correo) && correo !== 'admin') {
          mostrarError('correo', 'Solo se permiten correos @duoc.cl, @profesor.duoc.cl, @gmail.com o admin');
          esValido = false;
        }
        // Validación contraseña
        if (!password) {
          mostrarError('password', 'La contraseña es requerida');
          esValido = false;
        } else if ((password.length < 4 || password.length > 10) && password !== 'admin') {
          mostrarError('password', 'La contraseña debe tener entre 4 y 10 caracteres o ser admin');
          esValido = false;
        }
        if (esValido) {
          // Redirección especial para admin
          if (correo === 'admin' && password === 'admin') {
            window.location.href = '../admin/home.html';
            return;
          }
          const resultado = iniciarSesion(correo, password, recordar);
          if (resultado.exito) {
            mostrarExitoLogin();
            const sesion = resultado.usuario;
            let mensaje = '';
            if (sesion.descuento === 50) mensaje = '¡Tienes 50% de descuento en todos los productos!';
            else if (sesion.descuento === 10) mensaje = '¡Tienes 10% de descuento de por vida!';
            if (sesion.tortaGratis) mensaje += (mensaje ? ' y ' : '') + '¡Tienes una torta gratis por ser estudiante Duoc en tu cumpleaños!';
            if (mensaje) alert(mensaje);
            // Redirección especial para profesor.duoc.cl
            if (/^[^\s@]+@profesor\.duoc\.cl$/i.test(correo)) {
              setTimeout(() => {
                window.location.href = '../admin/home.html';
              }, 1200);
            } else {
              setTimeout(() => {
                window.location.href = '../../index.html';
              }, 1200);
            }
          } else {
            mostrarErrorLogin('Credenciales incorrectas. Verifica tu correo y contraseña.');
            correoInput.classList.add('invalid');
            passwordInput.classList.add('invalid');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        } else {
          // Si hay errores de validación, desplazarse suavemente al primer error
          const primerError = document.querySelector('.error-message.show');
          if (primerError) {
            primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
    });

    window.addEventListener('scroll', function(){
      const header=document.getElementById('mainHeader');
      if (window.scrollY>40) header.classList.add('shrink'); else header.classList.remove('shrink');
    });
  </script>
</body>
</html>
